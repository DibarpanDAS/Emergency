<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Emergency Link</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Dark mode base for low-light situations/battery saving */
        body {
            background-color: #111827;
            color: #f3f4f6;
            touch-action: manipulation;
        }
        /* Hide scrollbar but allow scrolling */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Loading spinner animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="h-[100dvh] flex flex-col font-sans relative">

    <!-- Header -->
    <div class="bg-red-600 text-white p-4 shadow-lg z-20 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-2">
            <i data-lucide="siren" class="w-6 h-6 animate-pulse"></i>
            <h1 class="font-bold text-lg tracking-wider">SECURE LINK</h1>
        </div>
        <div id="status-indicator" class="flex items-center gap-2 text-xs font-mono bg-red-700 px-2 py-1 rounded">
            <span class="w-2 h-2 rounded-full bg-yellow-400 animate-ping"></span>
            CONNECTING...
        </div>
    </div>

    <!-- Chat Area -->
    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar scroll-smooth">
        <!-- Messages will be injected here -->
        <div class="text-center text-gray-500 text-sm py-4">
            <p>End-to-End Emergency Channel</p>
            <p class="text-xs mt-1">Both parties share this URL.</p>
        </div>
    </div>

    <!-- Quick Actions (Quick Taps) -->
    <div class="bg-gray-900 p-2 grid grid-cols-4 gap-2 shrink-0 border-t border-gray-800">
        <button onclick="sendQuickMessage('I am safe.')" class="bg-green-700 hover:bg-green-600 p-2 rounded text-xs font-bold text-center text-white truncate">
            I'm Safe
        </button>
        <button onclick="sendLocation()" class="bg-blue-700 hover:bg-blue-600 p-2 rounded text-xs font-bold text-center text-white flex justify-center items-center gap-1 truncate">
            <i data-lucide="map-pin" class="w-3 h-3"></i> Loc
        </button>
        <button onclick="sendQuickMessage('Call Police!')" class="bg-red-900 hover:bg-red-800 p-2 rounded text-xs font-bold text-center text-red-100 truncate border border-red-700">
            Call 100
        </button>
        <!-- AI Help Button -->
        <button onclick="toggleAIModal()" class="bg-purple-700 hover:bg-purple-600 p-2 rounded text-xs font-bold text-center text-white flex justify-center items-center gap-1 truncate border border-purple-500">
            âœ¨ AI Help
        </button>
    </div>

    <!-- Input Area -->
    <div class="bg-gray-800 p-3 pb-safe shrink-0 border-t border-gray-700">
        <form id="message-form" class="flex gap-2 relative">
            <div class="relative flex-1">
                <input 
                    type="text" 
                    id="message-input" 
                    placeholder="Type message..." 
                    class="w-full bg-gray-700 text-white pl-4 pr-10 py-3 rounded-full focus:outline-none focus:ring-2 focus:ring-red-500 placeholder-gray-400"
                    autocomplete="off"
                >
                <!-- Magic Compose Button inside input -->
                <button type="button" onclick="magicCompose()" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-purple-400 hover:text-purple-200 p-1 rounded-full" title="AI Magic Rewrite">
                    âœ¨
                </button>
            </div>
            <button type="submit" class="bg-red-600 hover:bg-red-500 text-white p-3 rounded-full shadow-lg transition-transform active:scale-95">
                <i data-lucide="send-horizontal" class="w-6 h-6"></i>
            </button>
        </form>
    </div>

    <!-- AI Assistant Modal -->
    <div id="ai-modal" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex justify-center items-end md:items-center">
        <div class="bg-gray-800 w-full md:w-96 rounded-t-2xl md:rounded-2xl shadow-2xl border-t border-gray-700 p-4 animate-in slide-in-from-bottom duration-300">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h2 class="text-purple-400 font-bold flex items-center gap-2">
                    âœ¨ AI First Aid & Safety
                </h2>
                <button onclick="toggleAIModal()" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div id="ai-response-area" class="bg-gray-900 rounded-lg p-3 min-h-[150px] max-h-[300px] overflow-y-auto mb-4 text-sm text-gray-300 leading-relaxed">
                <p class="opacity-50 italic">Ask me about CPR, burns, panic attacks, or what to do in your specific emergency...</p>
            </div>

            <form onsubmit="handleAIQuery(event)" class="flex gap-2">
                <input type="text" id="ai-input" placeholder="e.g., How to stop bleeding?" class="flex-1 bg-gray-700 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-purple-500 text-sm">
                <button type="submit" class="bg-purple-600 text-white p-2 rounded-lg font-bold text-sm">Ask</button>
            </form>
        </div>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { createIcons, icons } from "https://esm.sh/lucide@0.263.1";

        // --- 1. FIREBASE CONFIG (Pre-filled from your screenshot) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDdxISL9HXXqGgIdEpwEI4XtFLUjZz_9e8",
            authDomain: "emergency-1309.firebaseapp.com",
            projectId: "emergency-1309",
            storageBucket: "emergency-1309.firebasestorage.app",
            messagingSenderId: "354870989012",
            appId: "1:354870989012:web:9406562b20ae7569b3eb41"
        };
        // ------------------------------------------

        // --- 2. GEMINI API KEY (Filled) ---
        const GEMINI_API_KEY = "AIzaSyBe0-dqu8yy7Z-09BnKYAgDAcTL1gG3YUY";
        // -----------------------------------------

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = "emergency-chat-public-room-v1"; 

        const myDeviceId = localStorage.getItem('emergency_device_id') || Math.random().toString(36).substring(7);
        localStorage.setItem('emergency_device_id', myDeviceId);

        const statusEl = document.getElementById('status-indicator');
        const chatContainer = document.getElementById('chat-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        
        // AI UI Elements
        const aiModal = document.getElementById('ai-modal');
        const aiResponseArea = document.getElementById('ai-response-area');
        const aiInput = document.getElementById('ai-input');

        createIcons({ icons });

        // --- GEMINI API INTEGRATION ---
        async function callGemini(prompt, systemInstruction = "") {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('AI Service Unavailable');
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "I couldn't generate a response.";
            } catch (error) {
                console.error("Gemini Error:", error);
                return "Error connecting to AI assistant.";
            }
        }

        // Feature 1: Magic Compose
        window.magicCompose = async () => {
            const originalText = messageInput.value.trim();
            if (!originalText) return;

            const originalPlaceholder = messageInput.placeholder;
            messageInput.value = "";
            messageInput.placeholder = "âœ¨ Rewriting...";
            messageInput.disabled = true;

            const systemPrompt = "You are an emergency communication assistant. Rewrite the user's input into a clear, concise, and calm message suitable for an emergency chat. Fix typos and grammar. Do not add conversational filler. Keep it under 2 sentences.";
            
            const enhancedText = await callGemini(originalText, systemPrompt);
            
            messageInput.value = enhancedText.replace(/^"|"$/g, ''); 
            messageInput.placeholder = originalPlaceholder;
            messageInput.disabled = false;
            messageInput.focus();
        };

        // Feature 2: AI Assistant Modal Logic
        window.toggleAIModal = () => {
            aiModal.classList.toggle('hidden');
            if (!aiModal.classList.contains('hidden')) {
                aiInput.focus();
            }
        };

        window.handleAIQuery = async (e) => {
            e.preventDefault();
            const query = aiInput.value.trim();
            if (!query) return;

            aiInput.value = "";
            aiResponseArea.innerHTML = `
                <div class="flex items-center gap-2 text-purple-400">
                    <i data-lucide="loader-2" class="w-4 h-4 spinner"></i>
                    Thinking...
                </div>`;
            createIcons({ icons });

            const systemPrompt = "You are an expert First Aid and Emergency Response guide. Provide short, bulleted, actionable steps for the user's emergency. Prioritize safety. Keep the response under 100 words. Do not use markdown formatting like bolding, just plain text or simple bullets.";
            
            const response = await callGemini(query, systemPrompt);
            aiResponseArea.innerHTML = response.replace(/\n/g, '<br>');
        };


        // --- FIREBASE LOGIC ---
        async function initApp() {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth Error:", error);
                statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> ERROR';
            }
        }

        function setupRealtimeListener(user) {
            statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> SECURE';
            const messagesRef = collection(db, 'chats');
            onSnapshot(messagesRef, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                messages.sort((a, b) => a.createdAt - b.createdAt);
                renderMessages(messages);
            }, (error) => {
                console.error("Stream Error:", error);
                statusEl.innerText = "Connection Lost";
            });
        }

        function renderMessages(messages) {
            chatContainer.innerHTML = '';
            if (messages.length === 0) {
                chatContainer.innerHTML = `
                    <div class="h-full flex flex-col justify-center items-center opacity-30">
                        <i data-lucide="shield-check" class="w-16 h-16 mb-4"></i>
                        <p>Channel Open</p>
                    </div>`;
                createIcons({ icons });
                return;
            }

            messages.forEach(msg => {
                const isMe = msg.senderId === myDeviceId;
                const date = new Date(msg.createdAt);
                const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                const wrapper = document.createElement('div');
                wrapper.className = `flex w-full ${isMe ? 'justify-end' : 'justify-start'}`;

                const bubbleClass = isMe 
                    ? 'bg-red-600 text-white rounded-l-2xl rounded-tr-2xl rounded-br-sm' 
                    : 'bg-gray-700 text-white rounded-r-2xl rounded-tl-2xl rounded-bl-sm';

                let contentHtml = `<p>${escapeHtml(msg.text)}</p>`;
                if (msg.type === 'location' && msg.coords) {
                    const mapUrl = `https://www.google.com/maps?q=${msg.coords.lat},${msg.coords.lng}`;
                    contentHtml = `
                        <div class="flex items-center gap-2 mb-1">
                            <i data-lucide="map-pin" class="w-4 h-4"></i>
                            <span class="font-bold">Location Shared</span>
                        </div>
                        <a href="${mapUrl}" target="_blank" class="text-xs underline text-blue-200 block mb-1">Open in Maps</a>
                        <div class="text-xs opacity-75 font-mono">${msg.coords.lat.toFixed(4)}, ${msg.coords.lng.toFixed(4)}</div>
                    `;
                }

                wrapper.innerHTML = `
                    <div class="max-w-[80%] ${bubbleClass} px-4 py-2 shadow-sm animate-in fade-in slide-in-from-bottom-2 duration-300">
                        ${contentHtml}
                        <div class="text-[10px] opacity-60 text-right mt-1">${timeStr}</div>
                    </div>
                `;

                chatContainer.appendChild(wrapper);
            });

            chatContainer.scrollTop = chatContainer.scrollHeight;
            createIcons({ icons });
        }

        window.sendMessage = async (e) => {
            if (e) e.preventDefault();
            const text = messageInput.value.trim();
            if (!text) return;
            messageInput.value = '';
            await addMessageToDb({
                text: text,
                type: 'text',
                createdAt: Date.now(),
                senderId: myDeviceId
            });
        };

        window.sendQuickMessage = (text) => {
            addMessageToDb({
                text: text,
                type: 'text',
                createdAt: Date.now(),
                senderId: myDeviceId
            });
        };

        window.sendLocation = () => {
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser");
                return;
            }
            const btn = document.activeElement;
            const originalText = btn.innerHTML;
            btn.innerText = "Locating...";
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    addMessageToDb({
                        text: `ðŸ“ My Location: ${position.coords.latitude}, ${position.coords.longitude}`,
                        type: 'location',
                        coords: { lat: position.coords.latitude, lng: position.coords.longitude },
                        createdAt: Date.now(),
                        senderId: myDeviceId
                    });
                    btn.innerHTML = originalText;
                }, 
                () => {
                    alert("Unable to retrieve location.");
                    btn.innerHTML = originalText;
                }
            );
        };

        async function addMessageToDb(data) {
            const user = auth.currentUser;
            if (!user) return;
            try {
                await addDoc(collection(db, 'chats'), data);
            } catch (e) {
                console.error("Send Error:", e);
                alert("Failed to send message. Check rules.");
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        messageForm.addEventListener('submit', window.sendMessage);
        initApp();
        onAuthStateChanged(auth, (user) => {
            if (user) setupRealtimeListener(user);
        });
    </script>
</body>
</html>